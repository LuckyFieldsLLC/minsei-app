import{r as a,A as J,j as e,g as L,I as K,J as z,C as V,t as W,K as X,F as Q,N as Z}from"./index-DWy39khm.js";import{T as x,C as ee}from"./aiService-XlMwY8J1.js";const te=p=>new Promise((S,h)=>{const g=new FileReader;g.onloadend=()=>{const o=g.result.split(";base64,");if(o.length!==2)return h(new Error("Malformed data URL"));const T=o[0].split(":")[1],N=o[1];S({mimeType:T,data:N})},g.onerror=R=>h(R),g.readAsDataURL(p)}),se=()=>e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-200 rounded-lg p-3 max-w-lg",children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),e.jsx("div",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),e.jsx("div",{className:"h-2 w-2 bg-gray-500 rounded-full animate-bounce"})]})})}),ae={name:"add_calendar_events",description:"ユーザーの依頼に基づき、一つ以上のイベントを委員の予定表カレンダーに追加します。",parameters:{type:x.OBJECT,properties:{events:{type:x.ARRAY,description:"追加するイベントの配列。",items:{type:x.OBJECT,properties:{title:{type:x.STRING,description:"イベントのタイトル。"},start:{type:x.STRING,description:"開始日時 (YYYY-MM-DDTHH:MM形式)。"},end:{type:x.STRING,description:"終了日時 (YYYY-MM-DDTHH:MM形式)。"},location:{type:x.STRING,description:"（任意）イベントの場所。"},description:{type:x.STRING,description:"（任意）イベントの詳細やメモ。"}},required:["title","start","end"]}}},required:["events"]}},le=({isOpen:p,onClose:S,provider:h,people:g,activities:R,profile:o,onSaveEvent:T,settings:N})=>{const[w,b]=a.useState([]),[E,_]=a.useState(""),[r,Y]=a.useState(!1),[$,M]=a.useState(""),[c,k]=a.useState(null),[D,C]=a.useState(!1),A=a.useRef(null),P=a.useRef(null),v=a.useRef(null),U=a.useRef(window.speechSynthesis),d=a.useCallback(()=>{U.current.speaking&&(U.current.cancel(),C(!1))},[]),H=a.useCallback(()=>{d(),S()},[S,d]);a.useEffect(()=>{p||d()},[p,d]),a.useEffect(()=>{var s;(s=P.current)==null||s.scrollIntoView({behavior:"smooth"})},[w,r]),a.useEffect(()=>{if(p){M(""),_(""),k(null),b([{role:"model",text:"こんにちは！私はあなたの業務をサポートするAIアシスタントです。台帳のデータに関する質問や、写真の内容についての質問など、何でも聞いてください。"}]);try{const t=h===J.GEMINI?localStorage.getItem("gemini_api_key"):localStorage.getItem("openai_api_key");if(!t)throw new Error("APIキーが設定されていません。");const l=g.map(n=>({name:n.name,furigana:n.furigana,age:n.age,gender:n.gender,address:n.address,status:n.status,householdType:n.householdType,followUpDate:n.followUpDate})),i=JSON.stringify(l,null,2),y=`
- 氏名: ${o.name||"未設定"}
- 役職: ${o.title||"未設定"}
- 自己紹介: ${o.bio||"未設定"}
- 担当地区概要: ${o.areaOfResponsibility||"未設定"}
`.trim(),u=new Date,m=u.getFullYear(),j=u.getMonth()+1,f=`あなたは民生委員の業務をサポートするAIアシスタントです。フレンドリーかつ丁寧な言葉遣いで、ユーザーの質問に答えてください。
あなたの主な役割は、提供されたJSONデータに基づいて、担当地区の住民に関する質問に答えることです。また、写真やテキストからカレンダーの予定を読み取り、ツールを使って予定表に追加することもできます。

あなたは以下のプロフィールを持つ民生委員です。この情報を元に、あなたとして振る舞ってください。
${y}

ユーザーからの質問に回答する際は、以下のJSONデータを唯一の情報源としてください。
データにない情報は「分かりません」と回答してください。
特定の条件に合う人をリストアップするよう求められた場合は、氏名、年齢、住所、ステータス等を箇条書きで分かりやすく提示してください。

ユーザーからカレンダーへの予定追加を依頼された場合は、必ず 'add_calendar_events' ツールを使用してください。
日付が不明確な場合（例：「15日」）、文脈から判断してください。特に指定がなければ、現在は${m}年${j}月です。

# 担当者データ
\`\`\`json
${i}
\`\`\`
`,I=h===J.GEMINI?[ae]:void 0;A.current=new ee(h,t,f,I)}catch(t){M(t.message),b(l=>[...l,{role:"model",text:`エラー: ${t.message}`}])}}},[p,h,g,R,o]),a.useEffect(()=>{if(N.aiVoiceResponse&&w.length>0){const s=w[w.length-1];if(s.role==="model"&&!r){d();const t=new SpeechSynthesisUtterance(s.text);t.lang="ja-JP",t.onstart=()=>C(!0),t.onend=()=>C(!1),t.onerror=()=>C(!1),U.current.speak(t)}}},[w,r,N.aiVoiceResponse,d]);const F=async s=>{s.preventDefault(),d();const t=E.trim();if(!t&&!c||r||!A.current)return;M("");let l=t;c&&!t?l="[画像]":c&&(l=`${t}
[画像]`),b(i=>[...i,{role:"user",text:l}]),_(""),Y(!0);try{let i;if(c){const m=await te(c.file),j=[];t&&j.push({text:t}),j.push({inlineData:m}),i=j}else i=t;k(null);const y=await A.current.sendMessage(i),u=y.functionCalls;if(u&&u.length>0){b(f=>[...f,{role:"model",text:"カレンダー情報を解析しました。予定を追加します..."}]);const m=[];for(const f of u)if(f.name==="add_calendar_events"){const I=f.args,n=[];if(I.events&&Array.isArray(I.events))for(const B of I.events){const q=await T(B);n.push(q)}m.push({functionResponse:{name:"add_calendar_events",response:{results:n}}})}const j=await A.current.sendMessage(m);b(f=>[...f,{role:"model",text:j.text}])}else b(m=>[...m,{role:"model",text:y.text}])}catch(i){const y=i.message||"AIとの通信中にエラーが発生しました。";M(y),b(u=>[...u,{role:"model",text:`エラーが発生しました: ${y}`}])}finally{Y(!1)}},O=s=>{var l;const t=(l=s.target.files)==null?void 0:l[0];t&&k({file:t,previewUrl:URL.createObjectURL(t)}),s.target&&(s.target.value="")},G=s=>{v.current&&(s?v.current.setAttribute("capture","environment"):v.current.removeAttribute("capture"),v.current.click())};return p?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[55] flex justify-center items-center p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-2xl h-[95vh] flex flex-col",children:[e.jsxs("header",{className:"flex-shrink-0 flex justify-between items-center p-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"h-7 w-7 text-theme-purple"}),e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"AIアシスタント"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[N.aiVoiceResponse&&e.jsx("button",{onClick:D?d:void 0,className:"text-gray-500 hover:text-brand-blue",title:D?"読み上げを停止":"AIの音声読み上げが有効です",children:D?e.jsx(K,{className:"h-6 w-6 animate-pulse text-red-500"}):e.jsx(z,{className:"h-6 w-6"})}),e.jsx("button",{onClick:H,className:"text-gray-500 hover:text-gray-800",children:e.jsx(V,{className:"h-6 w-6"})})]})]}),e.jsxs("main",{className:"flex-grow p-4 overflow-y-auto space-y-4",children:[w.map((s,t)=>e.jsxs("div",{className:`flex items-end gap-2 ${s.role==="user"?"justify-end":"justify-start"}`,children:[s.role==="model"&&e.jsx(L,{className:"h-6 w-6 text-theme-purple flex-shrink-0"}),e.jsx("div",{className:`rounded-lg p-3 max-w-lg ${s.role==="user"?"bg-brand-blue text-white":"bg-gray-200 text-gray-800"}`,children:e.jsx("p",{className:"whitespace-pre-wrap text-sm",dangerouslySetInnerHTML:{__html:s.text.replace(/\n/g,"<br />")}})}),s.role==="user"&&e.jsx(W,{className:"h-6 w-6 text-gray-400 flex-shrink-0"})]},t)),r&&e.jsx(se,{}),e.jsx("div",{ref:P})]}),e.jsxs("footer",{className:"flex-shrink-0 p-4 border-t bg-white",children:[c&&e.jsxs("div",{className:"mb-2 relative w-20 h-20 border rounded-md p-1 bg-gray-100",children:[e.jsx("img",{src:c.previewUrl,alt:"添付ファイルプレビュー",className:"w-full h-full object-cover rounded"}),e.jsx("button",{onClick:()=>k(null),className:"absolute -top-2 -right-2 bg-gray-700 text-white rounded-full p-0.5","aria-label":"添付ファイルを削除",children:e.jsx(V,{className:"h-4 w-4"})})]}),e.jsxs("form",{onSubmit:F,className:"flex items-center gap-2",children:[e.jsx("input",{type:"file",ref:v,onChange:O,accept:"image/*",className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>G(!1),"aria-label":"ファイルを添付",className:"p-2 text-gray-500 hover:text-brand-blue",disabled:r,children:e.jsx(X,{className:"h-6 w-6"})}),e.jsx("button",{type:"button",onClick:()=>G(!0),"aria-label":"カメラを起動",className:"p-2 text-gray-500 hover:text-brand-blue",disabled:r,children:e.jsx(Q,{className:"h-6 w-6"})}),e.jsx("input",{type:"text",value:E,onChange:s=>_(s.target.value),placeholder:r?"AIが応答中です...":"メッセージを入力...",disabled:r||!!$,className:"w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-blue bg-white text-gray-900","aria-label":"AIへのメッセージ"}),e.jsx("button",{type:"submit",disabled:r||!E.trim()&&!c,className:"p-3 bg-brand-blue text-white rounded-full hover:bg-blue-800 disabled:bg-gray-400 transition-colors","aria-label":"送信",children:e.jsx(Z,{className:"h-5 w-5"})})]}),$&&e.jsx("p",{className:"text-red-500 text-xs mt-2 text-center",children:$})]})]})}):null};export{le as default};
