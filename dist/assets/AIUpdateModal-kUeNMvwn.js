import{r as d,j as e,g as A,C as P,D as U,e as E}from"./index-DWy39khm.js";import{a as F}from"./aiService-XlMwY8J1.js";const T=o=>new Promise((g,i)=>{const c=new FileReader;c.onload=()=>{const l=c.result.split(";base64,");if(l.length!==2)return i(new Error("Malformed data URL"));const n=l[0].split(":")[1],m=l[1];g({mimeType:n,data:m})},c.onerror=x=>i(x),c.readAsDataURL(o)}),G=({text:o})=>e.jsxs("div",{className:"flex justify-center items-center p-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-blue"}),e.jsx("p",{className:"ml-3 text-gray-600",children:o})]}),z=({isOpen:o,onClose:g,person:i,provider:c,onApplyUpdates:x})=>{const[l,n]=d.useState("upload"),[m,b]=d.useState(null),[y,j]=d.useState([]),[u,h]=d.useState([]),[S,N]=d.useState(""),[v,p]=d.useState(""),f=()=>{n("upload"),b(null),j([]),h([]),N(""),p(""),g()},w=async s=>{if(s){p(""),b(s),n("loading");try{const t=localStorage.getItem("gemini_api_key");if(!t)throw new Error("Gemini APIキーが設定されていません。");const a=await T(s),r=await F(c,a,i,t);j(r.suggestions||[]),h(r.suggestions||[]),N(r.summary||"要約はありません。"),n("suggestions")}catch(t){p(t.message||"解析中に不明なエラーが発生しました。"),n("upload")}}},C=s=>{s.target.files&&s.target.files[0]&&w(s.target.files[0])},k=d.useCallback(s=>{s.preventDefault(),s.stopPropagation(),s.dataTransfer.files&&s.dataTransfer.files[0]&&w(s.dataTransfer.files[0])},[]),V=s=>{s.preventDefault(),s.stopPropagation()},D=s=>{h(t=>t.some(a=>a.field===s.field&&a.suggestedValue===s.suggestedValue)?t.filter(a=>!(a.field===s.field&&a.suggestedValue===s.suggestedValue)):[...t,s])},I=()=>{const s={},t=[];u.forEach(r=>{r.field==="activity"?t.push(r.suggestedValue):s[r.field]=r.suggestedValue});const a=t.join(`

`);x(i.id,s,a),f()};return o?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[55] flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col",children:[e.jsxs("header",{className:"flex justify-between items-center p-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"h-7 w-7 text-theme-green"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"AIによるデータ更新"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["対象者: ",i.name]})]})]}),e.jsx("button",{onClick:f,className:"text-gray-500 hover:text-gray-800",children:e.jsx(P,{className:"h-6 w-6"})})]}),e.jsxs("main",{className:"p-6 overflow-y-auto flex-grow",children:[l==="upload"&&e.jsxs("div",{onDrop:k,onDragOver:V,className:"border-2 border-dashed border-gray-300 rounded-lg p-10 text-center",children:[e.jsx("input",{type:"file",id:"ai-file-upload",className:"hidden",accept:"image/*,text/plain",onChange:C}),e.jsxs("label",{htmlFor:"ai-file-upload",className:"cursor-pointer",children:[e.jsx(U,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 font-semibold",children:"メモの写真や書類をここにドラッグ＆ドロップ"}),e.jsx("p",{className:"text-gray-500 text-sm my-2",children:"または"}),e.jsx("span",{className:"text-brand-blue font-semibold",children:"ファイルを選択"}),e.jsx("p",{className:"text-xs text-gray-400 mt-4",children:"対応ファイル: JPG, PNG, TXT"})]}),v&&e.jsx("p",{className:"text-red-500 bg-red-50 p-3 mt-4 rounded-md",children:v})]}),l==="loading"&&e.jsx(G,{text:m?`「${m.name}」を解析中...`:"解析中..."}),l==="suggestions"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"ドキュメントの要約"}),e.jsx("p",{className:"mt-1 p-3 bg-gray-50 rounded-md text-sm text-gray-700",children:S})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"AIからの更新提案"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"適用したい項目にチェックを入れてください。"}),e.jsx("div",{className:"space-y-3 border rounded-lg p-3 max-h-80 overflow-y-auto",children:y.length>0?y.map((s,t)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-blue-50/50 rounded-md",children:[e.jsx("input",{type:"checkbox",checked:u.some(a=>a.field===s.field&&a.suggestedValue===s.suggestedValue),onChange:()=>D(s),className:"mt-1 h-4 w-4 text-brand-blue focus:ring-brand-blue border-gray-300 rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:s.field==="activity"?"活動履歴の追加":`「${s.field}」の更新`}),e.jsxs("p",{className:"text-xs text-gray-500",children:["理由: ",s.reasoning]}),e.jsxs("div",{className:"mt-2 text-sm space-y-1",children:[s.field!=="activity"&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-500",children:"現在:"})," ",s.currentValue]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-green-700",children:"提案:"})," ",e.jsx("span",{className:"text-green-800 bg-green-100 rounded px-1 py-0.5",children:s.suggestedValue})]})]})]})]},t)):e.jsx("p",{className:"text-gray-500 text-center p-4",children:"提案できる更新項目はありませんでした。"})})]})]})]}),e.jsxs("footer",{className:"flex justify-between items-center p-4 border-t bg-gray-50 rounded-b-lg",children:[l==="suggestions"?e.jsx("button",{onClick:()=>n("upload"),className:"px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-md",children:"別のファイルを試す"}):e.jsx("div",{}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:f,className:"px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md",children:"キャンセル"}),l==="suggestions"&&e.jsxs("button",{onClick:I,disabled:u.length===0,className:"flex items-center px-4 py-2 bg-brand-blue text-white rounded-md hover:bg-blue-800 disabled:bg-gray-400",children:[e.jsx(E,{className:"h-5 w-5 mr-2"}),"選択した項目を適用"]})]})]})]})}):null};export{z as default};
